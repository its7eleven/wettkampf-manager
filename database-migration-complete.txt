<?php
/**
 * Vollständiges Datenbank-Migrations-Script für Transport-Optionen
 * Führe dieses Script einmalig aus um die Datenbank zu aktualisieren
 */

// WordPress Bootstrap
require_once('../../../wp-load.php');

// Nur Admin darf dieses Script ausführen
if (!current_user_can('manage_options')) {
    die('Keine Berechtigung.');
}

global $wpdb;

echo "<h1>Wettkampf Manager - Datenbank Migration</h1>";
echo "<p>Dieses Script aktualisiert die Datenbank für die neuen Transport-Optionen.</p>";

// Tabelle
$table_name = $wpdb->prefix . 'wettkampf_anmeldung';

try {
    // 1. Prüfe aktuelle Spaltenstruktur
    $column_info = $wpdb->get_row("SHOW COLUMNS FROM $table_name LIKE 'eltern_fahren'");
    
    if (!$column_info) {
        echo "<p style='color: red;'>❌ FEHLER: Spalte 'eltern_fahren' nicht gefunden!</p>";
        echo "<p>Die Tabelle existiert möglicherweise nicht oder ist beschädigt.</p>";
        exit;
    }
    
    echo "<h2>Aktuelle Spaltenstruktur:</h2>";
    echo "<pre>Type: " . $column_info->Type . "</pre>";
    echo "<pre>Default: " . $column_info->Default . "</pre>";
    
    // 2. Prüfe ob bereits ENUM
    if (strpos($column_info->Type, 'enum') !== false && strpos($column_info->Type, 'direkt') !== false) {
        echo "<p style='color: green;'>✓ Spalte ist bereits als ENUM mit allen 3 Optionen konfiguriert.</p>";
    } else {
        echo "<h2>Migration wird durchgeführt...</h2>";
        
        // 3. Erstelle temporäre Spalte
        echo "<p>Schritt 1: Erstelle temporäre Spalte...</p>";
        $wpdb->query("ALTER TABLE $table_name ADD COLUMN eltern_fahren_temp VARCHAR(20) AFTER eltern_fahren");
        
        // 4. Kopiere und konvertiere Daten
        echo "<p>Schritt 2: Konvertiere bestehende Daten...</p>";
        $wpdb->query("UPDATE $table_name SET eltern_fahren_temp = 
            CASE 
                WHEN eltern_fahren = '1' THEN 'ja'
                WHEN eltern_fahren = '0' THEN 'nein'
                WHEN eltern_fahren = 1 THEN 'ja'
                WHEN eltern_fahren = 0 THEN 'nein'
                WHEN eltern_fahren = 'ja' THEN 'ja'
                WHEN eltern_fahren = 'nein' THEN 'nein'
                WHEN eltern_fahren = 'direkt' THEN 'direkt'
                ELSE 'nein'
            END
        ");
        
        // 5. Lösche alte Spalte
        echo "<p>Schritt 3: Lösche alte Spalte...</p>";
        $wpdb->query("ALTER TABLE $table_name DROP COLUMN eltern_fahren");
        
        // 6. Erstelle neue ENUM Spalte
        echo "<p>Schritt 4: Erstelle neue ENUM Spalte...</p>";
        $wpdb->query("ALTER TABLE $table_name ADD COLUMN eltern_fahren ENUM('ja','nein','direkt') NOT NULL DEFAULT 'nein' AFTER jahrgang");
        
        // 7. Kopiere Daten zurück
        echo "<p>Schritt 5: Kopiere Daten zurück...</p>";
        $wpdb->query("UPDATE $table_name SET eltern_fahren = eltern_fahren_temp");
        
        // 8. Lösche temporäre Spalte
        echo "<p>Schritt 6: Lösche temporäre Spalte...</p>";
        $wpdb->query("ALTER TABLE $table_name DROP COLUMN eltern_fahren_temp");
        
        echo "<p style='color: green;'><strong>✓ Migration erfolgreich abgeschlossen!</strong></p>";
    }
    
    // 9. Zeige Statistik
    echo "<h2>Aktuelle Statistik:</h2>";
    $stats = $wpdb->get_results("
        SELECT eltern_fahren, COUNT(*) as anzahl 
        FROM $table_name 
        GROUP BY eltern_fahren
    ");
    
    echo "<table border='1' cellpadding='5'>";
    echo "<tr><th>Transport-Option</th><th>Anzahl</th></tr>";
    foreach ($stats as $stat) {
        $label = '';
        switch($stat->eltern_fahren) {
            case 'ja':
                $label = 'Ja, können andere Kinder mitnehmen';
                break;
            case 'nein':
                $label = 'Nein, brauchen eine Mitfahrgelegenheit';
                break;
            case 'direkt':
                $label = 'Wir fahren direkt zum Wettkampf';
                break;
            default:
                $label = 'Unbekannt: ' . $stat->eltern_fahren;
        }
        echo "<tr><td>$label</td><td>{$stat->anzahl}</td></tr>";
    }
    echo "</table>";
    
    // 10. Prüfe Struktur nach Migration
    echo "<h2>Neue Spaltenstruktur:</h2>";
    $new_column_info = $wpdb->get_row("SHOW COLUMNS FROM $table_name LIKE 'eltern_fahren'");
    echo "<pre>Type: " . $new_column_info->Type . "</pre>";
    echo "<pre>Default: " . $new_column_info->Default . "</pre>";
    
    // 11. Prüfe auf problematische Einträge
    $problem_entries = $wpdb->get_var("
        SELECT COUNT(*) 
        FROM $table_name 
        WHERE eltern_fahren NOT IN ('ja', 'nein', 'direkt')
    ");
    
    if ($problem_entries > 0) {
        echo "<p style='color: orange;'>⚠️ WARNUNG: Es gibt $problem_entries Einträge mit unbekannten Werten!</p>";
    }
    
} catch (Exception $e) {
    echo "<p style='color: red;'>❌ FEHLER: " . $e->getMessage() . "</p>";
}

echo "<hr>";
echo "<h3>Nächste Schritte:</h3>";
echo "<ol>";
echo "<li>Teste eine neue Anmeldung im Frontend</li>";
echo "<li>Prüfe ob alle 3 Transport-Optionen angezeigt werden</li>";
echo "<li>Teste die Bearbeitung einer Anmeldung im Backend</li>";
echo "<li>Lösche diese Datei nach erfolgreicher Migration</li>";
echo "</ol>";
echo "<p><a href='" . admin_url('admin.php?page=wettkampf-anmeldungen') . "' class='button button-primary'>Zur Anmeldungsverwaltung</a></p>";
?>